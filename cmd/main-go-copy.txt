package main

import (
	"crypto/rand"
	"crypto/rsa"
	"flag"
	"fmt"
	"os"
	"time"

	"github.com/labstack/echo/v4"
	"github.com/takumifahri/RESTful-API-GO/internal/database"
	"github.com/takumifahri/RESTful-API-GO/internal/delivery/rest"
	routers "github.com/takumifahri/RESTful-API-GO/internal/delivery/routes"
	"github.com/takumifahri/RESTful-API-GO/internal/middlewares"

	strRepo "github.com/takumifahri/RESTful-API-GO/internal/repository/catalog"
	orderRepo "github.com/takumifahri/RESTful-API-GO/internal/repository/order"
	authRepo "github.com/takumifahri/RESTful-API-GO/internal/repository/users/auth"

	"github.com/takumifahri/RESTful-API-GO/internal/delivery/rest/user"
	authUsecase "github.com/takumifahri/RESTful-API-GO/internal/usecase/auth"
	strUsecase "github.com/takumifahri/RESTful-API-GO/internal/usecase/store"
)


func getEnvWithDefault(key, defaultValue string) string {
    if value := os.Getenv(key); value != "" {
        return value
    }
    return defaultValue
}

var (
    dbAddress = fmt.Sprintf("host=%s port=%s user=%s password=%s dbname=%s sslmode=%s",
        getEnvWithDefault("HOST", "localhost"),
        getEnvWithDefault("PORT", "5432"),
        getEnvWithDefault("DB_USER", "postgres"),
        getEnvWithDefault("DB_PASSWORD", "postgres"),
        getEnvWithDefault("DB_NAME", "go_resto_app"),
        getEnvWithDefault("DB_SSLMODE", "disable"),
    )
)

func main() {
    // 1. Definisikan flags untuk command-line
    migrateFlag := flag.Bool("migrate", false, "Run database migrations")
    freshFlag := flag.Bool("fresh", false, "Drop all tables and run migrations (fresh start)")
    seedFlag := flag.Bool("seed", false, "Seed the database with initial data")
    resetFlag := flag.Bool("reset", false, "Drop all tables (same as fresh without seed)")

    // 2. Parse flags yang diberikan saat program dijalankan
    flag.Parse()

    // 3. Koneksikan ke database (diperlukan untuk semua perintah)
    db := database.ConnectDB(dbAddress)
    if db == nil {
        fmt.Println("FATAL: Failed to connect to database")
        os.Exit(1)
    }

    // 4. Logika untuk menjalankan perintah berdasarkan flag
    
    // Perintah: go run cmd/main.go --fresh --seed (drop + migrate + seed)
    if *freshFlag && *seedFlag {
        fmt.Println("Running fresh migration with seed...")
        database.FreshSeed(db)
        fmt.Println("Fresh migration with seed completed.")
        return
    }

    // Perintah: go run cmd/main.go --fresh (drop + migrate)
    if *freshFlag {
        fmt.Println("Running fresh migration...")
        database.DropAndMigrate(db)
        fmt.Println("Fresh migration completed.")
        return
    }

    // Perintah: go run cmd/main.go --reset (hanya drop tables)
    if *resetFlag {
        fmt.Println("Resetting database (dropping all tables)...")
        database.DropTables(db)
        fmt.Println("Database reset completed.")
        return
    }

    // Perintah: go run cmd/main.go --migrate --seed
    if *migrateFlag && *seedFlag {
        fmt.Println("Running migration with seed...")
        database.Migrate(db)
        database.Seed(db)
        fmt.Println("Migration with seed completed.")
        return
    }

    // Perintah: go run cmd/main.go --migrate
    if *migrateFlag {
        fmt.Println("Running migration...")
        database.Migrate(db)
        fmt.Println("Migration completed.")
        return
    }

    // Perintah: go run cmd/main.go --seed
    if *seedFlag {
        fmt.Println("Running seed...")
        database.Seed(db)
        fmt.Println("Seed completed.")
        return
    }

    // 5. Jika tidak ada flag, jalankan server (perilaku default)
    fmt.Println("No command flags detected, starting server...")
    e := echo.New()
    secret := "AES256Key-32Characters1234567890" // Ganti dengan secret key yang sesuai
    signKey, err := rsa.GenerateKey(rand.Reader, 4096)
    if err != nil {
        fmt.Println("Error generating RSA key:", err)
        os.Exit(1)
    }
    catalogRepo := strRepo.GetRepository(db)
    orderRepository := orderRepo.GetRepository(db)
    authRepos, err := authRepo.GetRepository(db, secret, 1, 64*1024, 4, 32, signKey, 100*time.Second)
    if err != nil {
        fmt.Println("Error initializing auth repository:", err)
        os.Exit(1)
    }
    storeUsecase := strUsecase.GetUsecase(catalogRepo, orderRepository)
    authUsecases := authUsecase.GetUsecase(authRepos)
    handler := rest.NewHandler(storeUsecase, authUsecases)
    authHandler := user.NewAuthHandler(handler)
    // kita tambahkan cors nya
    middlewares.CorsMiddleware(e)
    routers.LoadRoutes(e, handler, authHandler)
    fmt.Println("Server starting on port :8081")
    e.Logger.Fatal(e.Start(":8081"))
}